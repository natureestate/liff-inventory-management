#!/bin/bash

# ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Port 3100
# ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö kill process, ‡∏´‡∏¢‡∏∏‡∏î PID, ‡πÅ‡∏•‡∏∞ restart ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô

PORT=3100
APP_NAME="LIFF Inventory"

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡∏°‡∏¥‡∏ô‡∏±‡∏•
print_color() {
    case $2 in
        "green") echo -e "\033[32m$1\033[0m" ;;
        "red") echo -e "\033[31m$1\033[0m" ;;
        "yellow") echo -e "\033[33m$1\033[0m" ;;
        "blue") echo -e "\033[34m$1\033[0m" ;;
        *) echo "$1" ;;
    esac
}

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö process ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ port
check_port() {
    print_color "üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö process ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ port $PORT..." "blue"
    PID=$(lsof -ti tcp:$PORT)
    
    if [ -z "$PID" ]; then
        print_color "‚úÖ Port $PORT ‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà" "green"
        return 1
    else
        print_color "‚ö†Ô∏è  Port $PORT ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢ PID: $PID" "yellow"
        # ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á process
        ps -p $PID -o pid,ppid,cmd
        return 0
    fi
}

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô kill process ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ port
kill_port() {
    print_color "üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á kill process ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ port $PORT..." "blue"
    
    # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ PID ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ port
    PID=$(lsof -ti tcp:$PORT)
    
    if [ -z "$PID" ]; then
        print_color "‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ process ‡πÉ‡∏ä‡πâ port $PORT" "green"
        return 0
    fi
    
    # ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° kill ‡πÅ‡∏ö‡∏ö graceful ‡∏Å‡πà‡∏≠‡∏ô (SIGTERM)
    print_color "üì§ ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì SIGTERM ‡πÑ‡∏õ‡∏¢‡∏±‡∏á PID $PID..." "yellow"
    kill $PID
    
    # ‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏´‡πâ process ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏≠‡∏á
    sleep 3
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ process ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if kill -0 $PID 2>/dev/null; then
        print_color "‚ö° Force kill PID $PID ‡∏î‡πâ‡∏ß‡∏¢ SIGKILL..." "red"
        kill -9 $PID
        sleep 1
    fi
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
    if ! kill -0 $PID 2>/dev/null; then
        print_color "‚úÖ Process PID $PID ‡∏ñ‡∏π‡∏Å kill ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß" "green"
    else
        print_color "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ kill process PID $PID ‡πÑ‡∏î‡πâ" "red"
        return 1
    fi
}

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô
start_app() {
    print_color "üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô $APP_NAME ‡∏ö‡∏ô port $PORT..." "blue"
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ package.json ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if [ ! -f "package.json" ]; then
        print_color "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö package.json ‡πÉ‡∏ô‡πÑ‡∏î‡πÄ‡∏£‡∏Å‡∏ó‡∏≠‡∏£‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" "red"
        return 1
    fi
    
    # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô
    npm run dev -- --port $PORT &
    
    # ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    sleep 3
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if check_port > /dev/null; then
        print_color "‚úÖ $APP_NAME ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏ô port $PORT" "green"
        print_color "üåê ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå: http://localhost:$PORT" "blue"
    else
        print_color "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô $APP_NAME ‡πÑ‡∏î‡πâ" "red"
        return 1
    fi
}

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô restart ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô
restart_app() {
    print_color "üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á restart $APP_NAME..." "blue"
    
    # ‡∏´‡∏¢‡∏∏‡∏î process ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ port
    kill_port
    
    # ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà
    sleep 2
    
    # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
    start_app
}

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏ô‡∏π
show_menu() {
    echo ""
    print_color "=== üõ†Ô∏è  Port Manager ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö $APP_NAME (Port $PORT) ===" "blue"
    echo "1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö port"
    echo "2. Kill process ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ port"
    echo "3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô"
    echo "4. Restart ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô"
    echo "5. ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°"
    echo ""
}

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å
main() {
    # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ argument ‡πÄ‡∏õ‡πá‡∏ô command
    case $1 in
        "check")
            check_port
            ;;
        "kill")
            kill_port
            ;;
        "start")
            start_app
            ;;
        "restart")
            restart_app
            ;;
        "help"|"-h"|"--help")
            echo "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: $0 [command]"
            echo ""
            echo "Commands:"
            echo "  check    - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö process ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ port $PORT"
            echo "  kill     - Kill process ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ port $PORT"
            echo "  start    - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô"
            echo "  restart  - Restart ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô"
            echo "  help     - ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
            echo ""
            echo "‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ command ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö"
            ;;
        "")
            # ‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö
            while true; do
                show_menu
                read -p "üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (1-5): " choice
                
                case $choice in
                    1)
                        check_port
                        ;;
                    2)
                        kill_port
                        ;;
                    3)
                        start_app
                        ;;
                    4)
                        restart_app
                        ;;
                    5)
                        print_color "üëã ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Port Manager!" "green"
                        exit 0
                        ;;
                    *)
                        print_color "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1-5" "red"
                        ;;
                esac
                
                echo ""
                read -p "‚è∏Ô∏è  ‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠..."
            done
            ;;
        *)
            print_color "‚ùå Command ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: $1" "red"
            print_color "‡πÉ‡∏ä‡πâ '$0 help' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" "yellow"
            exit 1
            ;;
    esac
}

# ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å
main "$@" 